flow Check_Goods:
    MainNpc.NpcAISetting(9, false)
    MainNpc.NpcAISetting(5, false)
    MainNpc.SetNpcSpeakFlow('Root', 'SNPC_rcm_00_Groceries')
    return

flow Check_rcm:
    if MainNpc.NpcBlackBoard('CheckItemIndex', 0):
        MainNpc.NpcAISetting(9, false)
        MainNpc.NpcAISetting(5, false)
        MainNpc.SetNpcSpeakFlow('Check', 'SNPC_rcm')
    return

flow Close_rcm:
    run AI_NPC_Common::ContinueSpeak
    return

flow Enter_rcm:
    MainNpc.NpcAISetting(13, true)
    MainNpc.NpcAISetting(18, true)
    run AI_NPC_Common::Speak
    event_flags_system['cLandTemp:RcmEnterBalloon'] = true
    event_flags_system['cLandTemp:ShopEnterMessageFlag'] = true
    return

flow Init:
    MainNpc.SetSightRange(64, 0)
    MainNpc.NpcRegistAIBlackBoard('CheckItemIndex', -1)
    MainNpc.NpcRegistAIBlackBoard('DemoSpeak', 0)
    MainNpc.NpcAISetting(0, true)
    MainNpc.NpcAISetting(1, true)
    MainNpc.NpcAISetRequestSpeakFunc('cItemCheck', true)
    MainNpc.NpcRegistAIBlackBoard('GoodsRail', 2)
    MainNpc.NpcAISetRequestSpeakFunc('cLeaveRcm', true)
    MainNpc.NpcAISetRequestSpeakFunc('cEnterRcm', true)
    if EventFlowSystemActor.NetIsConnected():
        MainNpc.NpcAISetting(8, true)
        MainNpc.NpcChangeHeadCtrlMode('cPlayer', false)
        fEvent14 = EventFlowSystemActor.ShopLevel()
        if fEvent14 == NooksCrannyInitial:
            MainNpc.NpcAISetPosByRail(6, 0, -80.0, true)
            run sub_grp!Event24
        elif fEvent14 == NooksCrannyUpgraded:
            MainNpc.NpcAISetPosByRail(3, 0, 0.0, true)
            run sub_grp!Event24
    else:
        MainNpc.NpcAISetRequestSpeakFunc('cShopClose', false)
        MainNpc.NpcAISetting(8, false)
        run sub_grp!Event24
    return

flow Leave_rcm:
    run AI_NPC_Common::ContinueSpeak
    return

flow Rcm_Wait:
    MainNpc.NpcChangeAIState('cRcm', 'SNPC_rcm', 'Root', '', false, true)
    MainNpc.NpcChangeHeadCtrlMode('cPlayer', false)
    return

flow Root:
    if MainNpc.NpcCheckStateSelectTiming('cInit'):
        if EventFlowSystemActor.ShopLevel() in (InResServiceTent, NooksCrannyUpgraded):
            run Rcm_Wait
        elif (EventFlowSystemActor.IsMyVillage()) and (MainNpc.HghFreeQuery2('cHghQueryType_HghStayMarket')):
            MainNpc.NpcChangeConversationPretenseState('cConversationPretense', 'Root', 'SNPC_rcm', '', false, true, 0, 'hgh')
        else:
            run Rcm_Wait
    elif MainNpc.NpcBlackBoard('DemoSpeak', 1):
        MainNpc.NpcAISetting(4, false)
        MainNpc.NpcSetAIBlackBoard('DemoSpeak', 0)
        MainNpc.NpcAISetting(3, false)
        MainNpc.NpcAISetting(2, false)
        run AI_NPC_Common::Speak
    else:
        MainNpc.NpcAISetting(4, true)
        MainNpc.NpcChangeAIState('cRcm', 'SNPC_rcm', 'Root', '', false, true)
        MainNpc.NpcChangeHeadCtrlMode('cPlayer', false)
    return

flow sub_grp!Event24:
    if MainNpc.HghFreeQuery2('cHghQueryType_HghStayMarket'):
        MainNpc.NpcAISetPosByRail(5, 0, 0.0, false)
        event_flags_system['cLandTemp:HghStayMarketNow'] = true

