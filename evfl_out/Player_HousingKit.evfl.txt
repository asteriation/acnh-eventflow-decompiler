flow BridgeReserveKit:
    EventFlowSystemActor.SetTagFromUIResult(0, 'cBridgeSlopeKitName')
    EventFlowSystemActor.StructureStartPreviewGuide('cBridge', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cBridge', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:906', true)
        run HousingKitCommon
        event_flags_system['cPlayer:ContributedBuildBridgeorSlope'] = true
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_Bridge', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow CampSiteReserveKit:
    EventFlowSystemActor.StructureStartPreviewGuide('cCampSite', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cCampSite', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:909_03', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_CampSite_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow FacilityBuild_Root:
    if EventFlowSystemActor.UIPocketMenuItemSelected(2755):
        run MuseumReserveKit
    elif EventFlowSystemActor.UIPocketMenuItemSelected(2756):
        run ShopReserveKit
    elif EventFlowSystemActor.UIPocketMenuItemSelected(4411):
        run TailorReserveKit
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5166):
        run CampSiteReserveKit
    else:
        run Moving_root
    return

flow FirstNNPCTentKit:
    EventFlowSystemActor.SetTagFromUIResult(0, 'cTentNpcName')
    EventFlowSystemActor.StructureStartPreviewGuide('cNormalNpcHouse', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cNormalNpcHouse', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:904', true)
        run HousingKitCommon
        if EventFlowSystemActor.UIResultHousingKitNpcType() == 0:
            EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_HATent_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
        else:
            EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_ANTent_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow HouseBuild_Root:
    Player.PlayerDemoTurn('cNorth')
    if EventFlowSystemActor.UIPocketMenuItemSelected(3349):
        run NNPCReserveKit
    elif EventFlowSystemActor.UIPocketMenuItemSelected(2750):
        run PlayerTentkit
    elif EventFlowSystemActor.UIPocketMenuItemSelected(2757):
        run FirstNNPCTentKit
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5827):
        run MigrateQuestA
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5828):
        run MigrateQuestB
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5829):
        run MigrateQuestC
    else:
        run FacilityBuild_Root
    return

flow HousingKitCommon:
    fEvent20 = EventFlowSystemActor.GeneralTalkChoice3()
    if fEvent20 == 2:
        EventFlowSystemActor.StructureDeletePreviewGuide(false)
        EventFlowSystemActor.ExitFlowchart()
    elif fEvent20 == 1:
        EventFlowSystemActor.BuildStructurePlayReport('StructureType', 'StructureBuildPosType', 'BuildTiming')
        run System_Structure_Common::BuildStructure
        run sub_Event33
    elif fEvent20 == 0:
        EventFlowSystemActor.WaitFrame(15)
        Player.CharacterEmoticonAction('AbsentMindedness', '', 0, true, false)
        EventFlowSystemActor.WaitFrame(20)
        run System_Structure_Common::PreviewStructure
        Player.CharacterEmoticonAction('EmotEnd', '', 0, true, false)
        EventFlowSystemActor.WaitFrame(10)
        if EventFlowSystemActor.HasObstacle('StructureType', 'StructureBuildPosType', 'BuildTiming'):
            MainNpc.OpenMessageWindow('TalkSys/SYS_Player:931', true)
        else:
            MainNpc.OpenMessageWindow('TalkSys/SYS_Player:932', true)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            EventFlowSystemActor.BuildStructurePlayReport('StructureType', 'StructureBuildPosType', 'BuildTiming')
            run System_Structure_Common::DeletePreviewAndBuildStructure
            run sub_Event33
        else:
            run System_Structure_Common::DeletePreviewStructure
            EventFlowSystemActor.ExitFlowchart()
    return

flow HousingKitCommonError:
    EventFlowSystemActor.BuildStructureErrorMsg('StructureType', 'StructureBuildPosType', 'StructureBuildTiming')
    EventFlowSystemActor.BuildStructurePlayReport('StructureType', 'StructureBuildPosType', 'StructureBuildTiming')
    EventFlowSystemActor.StructureDeletePreviewGuide(false)
    return

flow MigrateQuestA:
    EventFlowSystemActor.StructureStartPreviewGuide('cReserveNpcHouse', 'cSettlerQuest', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cSettlerQuest', 'cReserveNpcHouse', 'BuildTiming'):
        Player.OpenMessageWindow('TalkSys/SYS_Player:909', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_NnpcImmigrateQuestA', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MigrateQuestB:
    EventFlowSystemActor.StructureStartPreviewGuide('cReserveNpcHouse', 'cSettlerQuest', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cSettlerQuest', 'cReserveNpcHouse', 'BuildTiming'):
        Player.OpenMessageWindow('TalkSys/SYS_Player:909_01', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_NnpcImmigrateQuestB', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MigrateQuestC:
    EventFlowSystemActor.StructureStartPreviewGuide('cReserveNpcHouse', 'cSettlerQuest', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cSettlerQuest', 'cReserveNpcHouse', 'BuildTiming'):
        Player.OpenMessageWindow('TalkSys/SYS_Player:909_02', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_NnpcImmigrateQuestC', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MovingKit_CampSite:
    EventFlowSystemActor.StructureStartPreviewGuide('cCampSite', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cCampSite', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:909_04', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_CampSiteMove', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MovingKit_Museum:
    EventFlowSystemActor.StructureStartPreviewGuide('cMuseum', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cMuseum', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:943', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_MuseumMove', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MovingKit_NNPC:
    EventFlowSystemActor.SetTagFromUIResult(0, 'cTentNpcName')
    EventFlowSystemActor.StructureStartPreviewGuide('cNormalNpcHouse', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cNormalNpcHouse', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:942', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_NPCHouseMove', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MovingKit_Player:
    EventFlowSystemActor.StructureStartPreviewGuide('cPlayerHouse', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cPlayerHouse', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:941', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_PcHouseMove', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MovingKit_Shop:
    EventFlowSystemActor.StructureStartPreviewGuide('cMarket', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cMarket', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:944', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_ShopMove', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow MovingKit_Tailor:
    EventFlowSystemActor.StructureStartPreviewGuide('cTailor', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cTailor', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:945', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_TailorMove', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow Moving_root:
    Player.PlayerDemoTurn('cNorth')
    if EventFlowSystemActor.UIPocketMenuItemSelected(5358):
        run MovingKit_Player
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5357):
        run MovingKit_NNPC
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5361):
        run MovingKit_Museum
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5360):
        run MovingKit_Shop
    elif EventFlowSystemActor.UIPocketMenuItemSelected(5359):
        run MovingKit_Tailor
    elif EventFlowSystemActor.UIPocketMenuItemSelected(6841):
        run MovingKit_CampSite
    return

flow MuseumReserveKit:
    EventFlowSystemActor.StructureStartPreviewGuide('cMuseum', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cMuseum', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:902', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_OwlTent_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow NNPCReserveKit:
    EventFlowSystemActor.StructureStartPreviewGuide('cReserveNpcHouse', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cReserveNpcHouse', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:905', true)
        run HousingKitCommon
        if event_flags_system['cLand:RcoMeetFirstVisitorOngoing']:
            event_flags_system['cLand:RcoMeetFirstVisitorComplete'] = true
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_NnpcNewProperty', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow PlayerTentkit:
    EventFlowSystemActor.StructureStartPreviewGuide('cPlayerHouse', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cPlayerHouse', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:901', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_PcTent_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow Root:
    if EventFlowSystemActor.IsRunningMiniGame('cTreasure'):
        Player.OpenMessageWindow('TalkSys/SYS_Player:990', false)
    elif (EventFlowSystemActor.UIPocketMenuItemSelected(4310)) or (EventFlowSystemActor.UIPocketMenuItemSelected(7211)):
        run sub_Event48
    elif EventFlowSystemActor.UIPocketMenuItemSelected(4311):
        run SlopeReserveKit
    else:
        run HouseBuild_Root
    return

flow ShopReserveKit:
    EventFlowSystemActor.StructureStartPreviewGuide('cMarket', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cMarket', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:903', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_Shop_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow SlopeReserveKit:
    EventFlowSystemActor.SetTagFromUIResult(0, 'cBridgeSlopeKitName')
    EventFlowSystemActor.StructureStartPreviewGuide('cSlope', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cSlope', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:907', true)
        run HousingKitCommon
        event_flags_system['cPlayer:ContributedBuildBridgeorSlope'] = true
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_Slope', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow TailorReserveKit:
    EventFlowSystemActor.StructureStartPreviewGuide('cTailor', 'cPlayer', 'BuildTiming')
    if EventFlowSystemActor.CanBuildHere('cPlayer', 'cTailor', 'BuildTiming'):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:908', true)
        run HousingKitCommon
        EventFlowSystemActor.ReservePlayerMutterDemo('HousingFinish_Tailor_Built', 'cNowDemoEnd', 'Player_Demo_HousingFinish', false)
    else:
        run HousingKitCommonError
    return

flow sub_Event33:
    EventFlowSystemActor.SystemDeletePlayerItem('cItemWindow', 1)

flow sub_Event48:
    run BridgeReserveKit

