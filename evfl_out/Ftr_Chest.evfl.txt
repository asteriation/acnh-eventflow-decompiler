flow Root:
    if EventFlowSystemActor.SystemCheckNowStage('cTalkingPlayerHouse'):
        run sub_Event57
    else:
        if EventFlowSystemActor.SystemCheckNowStage('cField'):
            if EventFlowSystemActor.IsMyVillage():
                run sub_Event57
            else:
                run Chest_PC_Other
        elif EventFlowSystemActor.SystemCheckNowStage('cAnyNpcHouse'):
            run Chest_NPC
        elif EventFlowSystemActor.SystemCheckNowStage('cOtherPlayerHouse'):
            run Chest_PC_Other
        else:
            run Chest_Naruhodo
    return

flow ClosetUI:
    event_flags_system['cPlayer:UseCloset'] = true
    if Player.PlayerIsUseCoordinate():
        EventFlowSystemActor.OpenMessageWindow('TalkFtr/FTR_Chest:013', false)
    elif event_flags_system['cPlayer:EquipLicenseHelmet']:
        EventFlowSystemActor.OpenMessageWindow('TalkFtr/FTR_Chest:018', false)
    elif Player.PlayerOutfitMarinesuit():
        EventFlowSystemActor.OpenMessageWindow('TalkFtr/FTR_Chest:019', false)
    else:
        EventFlowSystemActor.UIClosetHandling()
    return

flow Chest_PC_Current:
    if event_flags_system['cPlayer:HasGottenToolChangeStick']:
        EventFlowSystemActor.SetTagFromSystem(0, 'cStartFtrName', 'cDegit', '', 0)
        if not event_flags_system['cPlayer:Closet_Explain_ChangeStick']:
            event_flags_system['cPlayer:Closet_Explain_ChangeStick'] = true
            EventFlowSystemActor.OpenMessageWindow('Dialog/DIALOG_Msg:0504', false)
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:009', true)
        fEvent24 = EventFlowSystemActor.GeneralTalkChoice3()
        if fEvent24 == 0:
            run ClosetUI
        elif fEvent24 == 1:
            if (EventFlowSystemActor.NetIsConnected()) and (EventFlowSystemActor.NetHasVisitor()):
                EventFlowSystemActor.OpenMessageWindow('TalkSys/SYS_Telepathy:015', false)
            else:
                if Player.PlayerIsUseCoordinate():
                    EventFlowSystemActor.OpenMessageWindow('TalkFtr/FTR_Chest:012', false)
                elif event_flags_system['cPlayer:EquipLicenseHelmet']:
                    EventFlowSystemActor.OpenMessageWindow('TalkFtr/FTR_Chest:017', false)
                elif Player.PlayerOutfitMarinesuit():
                    EventFlowSystemActor.OpenMessageWindow('TalkFtr/FTR_Chest:020', false)
                else:
                    EventFlowSystemActor.UICoordinateEditHandling()
    else:
        EventFlowSystemActor.UIClosetCreate()
        EventFlowSystemActor.SetTagFromSystem(0, 'cStartFtrName', 'cDegit', '', 0)
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:008', true)
        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
            run ClosetUI
    return

flow Chest_NPC:
    run Chest_OtherCheck1st
    EventFlowSystemActor.UIClosetLotteryHandling()
    if EventFlowSystemActor.UIClosetItemNum() == 0:
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:002', false)
    else:
        EventFlowSystemActor.UIClosetBalloonAppearHandling()
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:015', false)
        EventFlowSystemActor.UIClosetBalloonDisappear()
    return

flow Chest_OtherCheck1st:
    if not event_flags_system['cPlayerTemp:FtrChestCheck']:
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:001', false)
        event_flags_system['cPlayerTemp:FtrChestCheck'] = true
    return

flow Chest_PC_Other:
    run Chest_OtherCheck1st
    EventFlowSystemActor.UIClosetLotteryHandling()
    if EventFlowSystemActor.UIIsExistCoordinateSet():
        EventFlowSystemActor.UIClosetBalloonAppearHandling()
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:010', false)
        EventFlowSystemActor.UIClosetBalloonDisappear()
    elif EventFlowSystemActor.IsMyVillage():
        fEvent19 = EventFlowSystemActor.UIClosetItemNum()
        if fEvent19 == 0:
            Player.OpenMessageWindow('TalkFtr/FTR_Chest:002', false)
        elif fEvent19 == 1:
            Player.OpenMessageWindow('TalkFtr/FTR_Chest:003', false)
        elif fEvent19 == 2:
            Player.OpenMessageWindow('TalkFtr/FTR_Chest:004', false)
        elif fEvent19 == 3:
            Player.OpenMessageWindow('TalkFtr/FTR_Chest:005', false)
        elif fEvent19 == 4:
            Player.OpenMessageWindow('TalkFtr/FTR_Chest:006', false)
    else:
        Player.OpenMessageWindow('TalkFtr/FTR_Chest:015', false)
    return

flow Chest_Naruhodo:
    Player.OpenMessageWindow('TalkFtr/FTR_Chest:015', false)
    return

flow sub_Event57:
    run Chest_PC_Current

