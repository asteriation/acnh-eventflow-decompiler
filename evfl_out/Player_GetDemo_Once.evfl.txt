flow FinishDonationBuildBridgeSlope:
    Player.OpenMessageWindow('TalkSys/SYS_Player:215', false)
    return

flow Finish_1stKkLive:
    Player.OpenMessageWindow('TalkSys/SYS_Player:212', true)
    if EventFlowSystemActor.MainPlayerIsBirthday(true):
        EventFlowSystemActor.SystemRequestChangeStage('cMainFieldPlayerHouse', 'cCircle', 'cCircle', 'cBlack', 1.0, 1.0)
    elif EventFlowSystemActor.EventBranch(false, 0) == 3:
        EventFlowSystemActor.SystemReenterStage(0, 'cCircle', 'cCircle', 'cBlack', 1.0, 1.0)
    return

flow Get_FinishLoan:
    event_flags_system['cPlayer:PlayerLoanRepaying'] = false
    event_flags_system['cPlayer:PlayerLoanFinish1st'] = true
    fEvent30 = EventFlowSystemActor.PlayerHouseLevel()
    if fEvent30 in (1, 2, 3, 4, 5, 6, 7):
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:204_02', false)
        event_flags_system['cLifeSupportAchievement:RepayLoan'] += 1
        EventFlowSystemActor.NpcPlayerActivity('cActivityType_ReturnLoan')
    elif fEvent30 == 8:
        MainNpc.OpenMessageWindow('TalkSys/SYS_Player:204_03', false)
        event_flags_system['cLifeSupportAchievement:RepayLoan'] += 1
        EventFlowSystemActor.NpcPlayerActivity('cActivityType_ReturnLoan')
    return

flow Get_MainGame:
    Player.OpenMessageWindow('TalkSys/SYS_Player:200', true)
    if event_flags_system['cPlayer:MakeVillagePlayerFlag']:
        EventFlowSystemActor.ReservePlayerMutterDemo('Get_MainGame_Continue', 'cNextDemoEnd_Simple', 'Player_GetDemo_Once', false)
    else:
        run Demo_PublicAnnouncement_Process::Root
        EventFlowSystemActor.ReservePlayerMutterDemo('Get_MainGame_Continue2P', 'cNextDemoEnd_Simple', 'Player_GetDemo_Once', false)
    return

flow Get_MainGame_Continue:
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.OpenMessageWindow('TalkSys/SYS_Guide:001_01', false)
    EventFlowSystemActor.OpenMessageWindow('TalkSys/SYS_Guide:002', true)
    event_flags_system['cLand:ValidateVillageSave'] = true
    event_flags_system['cLand:OpeningSeqBGMChangeCounter'] = 7
    run SetLocalFruitFlag
    run StartMainGameBitSet
    return

flow Get_MainGame_Continue2P:
    EventFlowSystemActor.WaitFrame(30)
    EventFlowSystemActor.OpenMessageWindow('TalkSys/SYS_Guide:001_02', false)
    EventFlowSystemActor.OpenMessageWindow('TalkSys/SYS_Guide:002', true)
    event_flags_system['cPlayer:PlayerEnableEating'] = true
    event_flags_system['cPlayer:PlayerPocketUIEnable'] = true
    event_flags_system['cPlayer:PlayerPickupEnable'] = true
    event_flags_system['cPlayer:NnpcFinishHintTalk'] = true
    event_flags_system['cLandTemp:CalendarEventStop'] = false
    event_flags_system['cPlayer:AllowPcTentEntering'] = true
    if not event_flags_system['cPlayer:MakeVillagePlayerFlag']:
        EventFlowSystemActor.NpcSetRewardRecipe(7142, false)
        EventFlowSystemActor.SystemMailSendDirect('cNintendo', 'MAIL_SP_Nintendo', 'cReward', 2)
        EventFlowSystemActor.StartupMailSend(true, true, true)
    fEvent46 = EventFlowSystemActor.ShopLevel()
    if fEvent46 == NooksCrannyInitial:
        event_flags_system['cPlayer:RcmHeardAboutNewOpen1'] = true
        run sub_grp!Event48
    elif fEvent46 == NooksCrannyUpgraded:
        event_flags_system['cPlayer:RcmHeardAboutNewOpen2'] = true
        run sub_grp!Event48
    elif fEvent46 == InResServiceTent:
        run sub_grp!Event48
    return

flow Get_ShoppingAppli:
    Player.OpenMessageWindow('TalkSys/SYS_Player:216', false)
    return

flow ImmQComplete_Notice:
    Player.OpenMessageWindow('TalkSys/SYS_Player:214_01', false)
    event_flags_system['cPlayer:ImmQCompleteDemo'] = true
    return

flow ImmQComplete_PutIn:
    Player.OpenMessageWindow('TalkSys/SYS_Player:213', false)
    event_flags_system['cPlayer:ImmQCompleteDemo'] = true
    return

flow SetLocalFruitFlag:
    fEvent8 = EventFlowSystemActor.LandFruit()
    if fEvent8 == 0:
        event_flags_system['cLand:IslandLocalFruitCherry'] = true
    elif fEvent8 == 1:
        event_flags_system['cLand:IslandLocalFruitOrange'] = true
    elif fEvent8 == 2:
        event_flags_system['cLand:IslandLocalFruitPear'] = true
    elif fEvent8 == 3:
        event_flags_system['cLand:IslandLocalFruitPeach'] = true
    elif fEvent8 == 4:
        event_flags_system['cLand:IslandLocalFruitApple'] = true
    return

flow StartMainGameBitSet:
    event_flags_system['cLifeSupportAchievement:ImmigratetoIsland'] += 1
    event_flags_system['cPlayer:EnablePcTownDecoration'] = true
    event_flags_system['cPlayer:ValidatePlayerSaveFlag'] = true
    event_flags_system['cPlayer:PcMaingameStart'] = true
    EventFlowSystemActor.SaveUpdateBackupCustomData()
    return

flow sub_grp!Event48:
    fEvent48 = EventFlowSystemActor.OfficeLevel()
    if fEvent48 == ResServiceBuilding:
        event_flags_system['cPlayer:RcoFirstTalkNewOffice'] = true
        if event_flags_system['cLand:TailorBuilt']:
            event_flags_system['cPlayer:PAnnounceTailorBuilt'] = true
        if event_flags_system['cLand:CampSiteBuilt']:
            event_flags_system['cPlayer:PAnnounceCampsite'] = true
        fEvent58 = EventFlowSystemActor.MuseumLevel()
        if fEvent58 == BlathersNotMovedIn:
            run StartMainGameBitSet
            EventFlowSystemActor.NpcInitializeActivity(-1)
            EventFlowSystemActor.CalendarEventStartFor2P()
            EventFlowSystemActor.ResetNpcScheduleForStart()
            EventFlowSystemActor.SystemReenterStage(2, 'cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929)
        elif fEvent58 == BlathersTent:
            event_flags_system['cPlayer:AnnouncementOwlMovedIn'] = true
            run StartMainGameBitSet
            EventFlowSystemActor.NpcInitializeActivity(-1)
            EventFlowSystemActor.CalendarEventStartFor2P()
            EventFlowSystemActor.ResetNpcScheduleForStart()
            EventFlowSystemActor.SystemReenterStage(2, 'cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929)
        elif fEvent58 in (BlathersMuseumNoArt, BlathersMuseumArt):
            event_flags_system['cPlayer:TownNewsHeardMuseumOpenFlag'] = true
            run StartMainGameBitSet
            EventFlowSystemActor.NpcInitializeActivity(-1)
            EventFlowSystemActor.CalendarEventStartFor2P()
            EventFlowSystemActor.ResetNpcScheduleForStart()
            EventFlowSystemActor.SystemReenterStage(2, 'cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929)
    elif fEvent48 in (ResServiceTent0, ResServiceTent1):
        if event_flags_system['cLand:TailorBuilt']:
            event_flags_system['cPlayer:PAnnounceTailorBuilt'] = true
        if event_flags_system['cLand:CampSiteBuilt']:
            event_flags_system['cPlayer:PAnnounceCampsite'] = true
        fEvent58 = EventFlowSystemActor.MuseumLevel()
        if fEvent58 == BlathersNotMovedIn:
            run StartMainGameBitSet
            EventFlowSystemActor.NpcInitializeActivity(-1)
            EventFlowSystemActor.CalendarEventStartFor2P()
            EventFlowSystemActor.ResetNpcScheduleForStart()
            EventFlowSystemActor.SystemReenterStage(2, 'cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929)
        elif fEvent58 == BlathersTent:
            event_flags_system['cPlayer:AnnouncementOwlMovedIn'] = true
            run StartMainGameBitSet
            EventFlowSystemActor.NpcInitializeActivity(-1)
            EventFlowSystemActor.CalendarEventStartFor2P()
            EventFlowSystemActor.ResetNpcScheduleForStart()
            EventFlowSystemActor.SystemReenterStage(2, 'cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929)
        elif fEvent58 in (BlathersMuseumNoArt, BlathersMuseumArt):
            event_flags_system['cPlayer:TownNewsHeardMuseumOpenFlag'] = true
            run StartMainGameBitSet
            EventFlowSystemActor.NpcInitializeActivity(-1)
            EventFlowSystemActor.CalendarEventStartFor2P()
            EventFlowSystemActor.ResetNpcScheduleForStart()
            EventFlowSystemActor.SystemReenterStage(2, 'cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929)

