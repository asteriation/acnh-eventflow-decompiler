flow BeforeOpen:
    if EventFlowSystemActor.IsMyVillage():
        if not event_flags_system['cPlayer:FoxTalkTodayFlag']:
            event_flags_system['cPlayer:FoxTalkTodayFlag'] = true
            event_flags_system['cPlayer:FoxPreVisitWantSellFlag'] = false
            if not event_flags_system['cPlayer:TunekichiTalkBefore']:
                event_flags_system['cPlayer:TunekichiTalkBefore'] = true
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:101', false)
            elif event_flags_system['cPlayer:FoxTalkOnlyStandShopFlag']:
                event_flags_system['cPlayer:FoxTalkOnlyStandShopFlag'] = false
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:101_01', false)
            elif event_flags_system['cPlayer:FoxPreVisitBuyArtFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:102_01', false)
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:103', false)
            else:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:102_02', false)
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:103', false)
            if EventFlowSystemActor.NetHasVisitor():
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:106', false)
            else:
entrypoint Event87:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:105', false)
                if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:105_01', false)
                else:
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:105_02', false)
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:105_03', true)
                event_flags_system['cPlayer:FoxInvitedShipFlag'] = true
                event_flags_system['cLand:FoxMovedToMarket'] = true
                EventFlowSystemActor.WaitFrame(10)
                EventFlowSystemActor.FadeOut('cCircle', 'cCircle', 'cBlack', 0.800000011920929, 0.800000011920929, true)
                EventFlowSystemActor.WaitFrame(30)
                MainNpc.NpcRequestAction(3)
                EventFlowSystemActor.FadeIn(true)
        elif EventFlowSystemActor.NetHasVisitor():
            MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:107', false)
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:104', false)
            run OpenShip
    elif event_flags_system['cPlayerVisit:FoxTalkFlag']:
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:161', false)
    else:
        event_flags_system['cPlayerVisit:FoxTalkFlag'] = true
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:160', false)
    return

flow BuyArtAgain:
    if EventFlowSystemActor.HasBellCount('ArgPrice'):
        run Event24
    else:
        run Event25
    return

flow BuyArtCmnChk:
    if (not event_flags_system['cLand:Museum2ConstructionToday']) and (not event_flags_system['cLand:MuseumGrowupEnable2']) and (event_flags_system['cPlayer:OwlPaintingQuestExplain']) and (not event_flags_system['cLand:FoxPreVisitAlreadyBuyToday']) and (not event_flags_system['cPlayer:FoxPreVisitBuyArtMaxFlag']):
        subflow_results[0] = 1
    return

flow BuyArtFirst:
    event_flags_system['cPlayer:FoxPreVisitWantSellFlag'] = true
    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:003_01', false)
    EventFlowSystemActor.UIMoneyAppear()
    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:003_02', false)
    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:004', false)
    if EventFlowSystemActor.GeneralTalkChoice2() != 0:
        EventFlowSystemActor.UIMoneyDisappear()
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:007', false)
    elif EventFlowSystemActor.HasBellCount('ArgPrice'):
entrypoint Event24:
        if EventFlowSystemActor.SystemHasBaggageSpace(1, 'cPocketBag'):
            MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:005', false)
            MainNpc.SetDeliveryItemAtRandom(2114, false, 'cVillageRemakePattern', 0)
            MainNpc.NpcDelivery('Default', 0)
            EventFlowSystemActor.BellCountDown('ArgPrice', True)
            MainNpc.SetDeliveryItem(34, true)
            MainNpc.NpcDelivery('Default', 1)
            EventFlowSystemActor.UIMoneyDisappear()
            if event_flags_system['cPlayer:FoxPreVisitBuyArtFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:021', false)
                event_flags_system['cPlayer:FoxPreVisitBuyArtMaxFlag'] = true
            else:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:006', false)
                event_flags_system['cPlayer:FoxPreVisitBuyArtFlag'] = true
            event_flags_system['cPlayer:FoxPreVisitWantSellFlag'] = false
            event_flags_system['cLand:FoxPreVisitAlreadyBuyToday'] = true
        else:
            MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:009', false)
    else:
entrypoint Event25:
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:008', false)
    return

flow OpenShip:
    run Event87
    return

flow PreVisit:
    if EventFlowSystemActor.IsMyVillage():
        run BuyArtCmnChk
        if event_flags_system['cPlayer:FoxPreVisitBuyArtFlag']:
            entry_variables['ArtPrice'] = 49800
        else:
            entry_variables['ArtPrice'] = 4980
        MainNpc.SetItemName(0, 34, 0)
        EventFlowSystemActor.SetTagFromSystem(0, 'cFlow', 'cMoney', '', 'ArtPrice')
        if event_flags_system['cPlayer:FoxTalkTodayFlag']:
            if event_flags_system['cPlayer:FoxPreVisitWantSellFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:011', false)
                if subflow_results[0] == 0:
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:014', false)
                    event_flags_system['cPlayer:FoxPreVisitWantSellFlag'] = false
                else:
                    EventFlowSystemActor.UIMoneyAppear()
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:012', false)
                    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                        run BuyArtAgain
                    else:
                        EventFlowSystemActor.UIMoneyDisappear()
                        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:013', false)
            elif subflow_results[0] == 0:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:050', false)
            else:
                if not event_flags_system['cPlayer:FoxPreVisitBuyArtFlag']:
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:010', false)
                    run BuyArtFirst
                elif EventFlowSystemActor.HasKindItem('cFilter', '', 'OwlDonation1_5'):
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:050', false)
                else:
                    MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:017', false)
                    if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                        event_flags_system['cPlayer:FoxPreVisitWantSellFlag'] = true
                        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:019', false)
                        EventFlowSystemActor.UIMoneyAppear()
                        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:019_01', false)
                        if EventFlowSystemActor.GeneralTalkChoice2() == 0:
                            run BuyArtAgain
                        else:
                            EventFlowSystemActor.UIMoneyDisappear()
                            MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:020', false)
                    else:
                        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:018', false)
        elif event_flags_system['cPlayer:TunekichiTalkBefore']:
            event_flags_system['cPlayer:FoxTalkTodayFlag'] = true
            if event_flags_system['cPlayer:FoxTalkOnlyStandShopFlag']:
                event_flags_system['cPlayer:FoxTalkOnlyStandShopFlag'] = false
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:001_01', false)
                run sub_grp!Event127
            elif event_flags_system['cPlayer:FoxPreVisitBuyArtFlag']:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:016', false)
            else:
                MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:015', false)
        else:
            event_flags_system['cPlayer:TunekichiTalkBefore'] = true
            event_flags_system['cPlayer:FoxTalkTodayFlag'] = true
            MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:001', false)
            run sub_grp!Event127
    elif event_flags_system['cPlayerVisit:FoxTalkFlag']:
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:061', false)
    else:
        event_flags_system['cPlayerVisit:FoxTalkFlag'] = true
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:060', false)
    return

flow sub_grp!Event127:
    if subflow_results[0] != 0:
        run BuyArtFirst
    elif event_flags_system['cPlayer:OwlPaintingQuestExplain']:
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:002_01', false)
    else:
        MainNpc.OpenMessageWindow('TalkSNpc/fox/SP_fox_01_PreVisit:002_02', false)

