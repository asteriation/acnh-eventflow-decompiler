flow Root:
    MainNpc.NpcAIDefaultSetting(1)
    MainNpc.SetIsStartNeedActivity('cOff')
    if not EventFlowSystemActor.SystemCheckNowStage('cVisitPHouse'):
        MainNpc.SetIsStartNeedActivity('cOn')
    elif MainNpc.NpcBlackBoard('VisitPHide', 1):
        MainNpc.NpcAISetting(4, false)
        MainNpc.NpcChangeAIState('cVisitPHide', 'NNPC_Quest_VisitP_Home', 'Home_In', '', true, false)
    elif MainNpc.NpcBlackBoard('VisitPGreet', 1):
        MainNpc.NpcSetAIBlackBoard('VisitPGreet', 0)
        MainNpc.NpcAISetting(5, false)
        MainNpc.NpcAISetting(4, false)
        MainNpc.NpcAISetting(2, false)
        MainNpc.NpcChangeAIState('cVisitPGreet', 'NNPC_Quest_VisitP_Home', 'Home_Talk', '', false, true)
    elif MainNpc.NpcBlackBoard('VisitPMove', 1):
        MainNpc.NpcChangeAIState('cVisitPMove', 'NNPC_Quest_VisitP_Home', 'Home_Talk', '', false, true)
        MainNpc.NpcSetAIBlackBoard('VisitPMove', 0)
    elif (MainNpc.NpcCheckStateSelectTiming('cTalkEnd')) and (event_flag_npc['cNpcTemp:TalkEndWait']):
        MainNpc.NpcChangeWaitState('cWait', 'Home_Talk', 'NNPC_Quest_VisitP_Home', '', false, false, 30, true, '')
        event_flags_npc['cNpcTemp:TalkEndWait'] = false
    else:
        run sub_grp!Event41
    return

flow Init:
    run AI_NPC_Indoor::BBRegist
    if EventFlowSystemActor.SystemCheckNowStage('cVisitPHouse'):
        MainNpc.NpcRegistAIBlackBoard('VisitPHide', 0)
        MainNpc.NpcRegistAIBlackBoard('VisitPGreet', 0)
        MainNpc.NpcRegistAIBlackBoard('VisitPMove', 0)
        if MainNpc.SystemIsInviteQuestNpcEntered():
            MainNpc.NpcSetAIBlackBoard('VisitPMove', 1)
        elif MainNpc.SystemVisitQuestKind('cPlayer'):
            MainNpc.SystemSetInviteQuestEnterTime()
            MainNpc.SystemSetInviteQuestNpcEnterFlag()
            MainNpc.NpcSetAIBlackBoard('VisitPGreet', 1)
        else:
            MainNpc.NpcSetAIBlackBoard('VisitPHide', 1)
    return

flow VisitPCall:
    MainNpc.NpcAISetting(5, false)
    MainNpc.NpcAISetting(4, false)
    run AI_NPC_Common::ContinueSpeak
    return

flow VisitPGoHome:
    run AI_NPC_Common::ContinueSpeak
    return

flow VisitPGreet:
    run AI_NPC_Common::ContinueSpeak
    return

flow TouchedFurniture:
    run AI_NPC_Indoor::TouchedFurniture
    return

flow ExitStrc:
    MainNpc.NpcChangeAIState('cExitReaction', '', '', '', false, false)
    return

flow sub_grp!Event41:
    if event_flag_npc['cNpcTemp:AtHomeAI']:
        MainNpc.SetNpcTalkFlowName('NNPC_Quest_VisitP_Home', 'Home_Talk')
        MainNpc.SetIsStartNeedActivity('cOnKeepTalkFlow')
    else:
        MainNpc.NpcChangeAIState('cVisitWander', 'NNPC_Quest_VisitP_Home', 'Home_Talk', '', false, false)

